let path = require('path')
let fs = require('fs')
let rimraf = require('rimraf')
let shell = require('shelljs')

function generateCertbotCerts(args){
	let out = './output'
	let tmp = out+'/tmp'
	let perm = out+'/perm'
	let dirs = {
		sites: tmp+'/sites/',
		certs: perm+'/certs/',
		scripts: tmp+'/scripts/',
		confs: tmp+'/confs/',
		certbotcerts: perm+'/letsencrypt/live/',
	}
	let paths = {
		script: dirs.scripts+'script.tmp.sh',
		ssl: dirs.confs+'ssl.tmp.conf',
	}
	shell.cd(path.dirname(require.main.filename)+'/../')
	let sites = require('sites')(args)
	for(var dir of Object.keys(dirs)){
		if(dir.indexOf(tmp)) rimraf.sync(dir)
		try {
			fs.mkdirSync(dirs[dir], { recursive: true })
		} catch(err){
			// console.log(err)
		}
	}
	for(var site of sites){
		if(site.certbot){
			console.log('running syncVolumes')
			shell.exec(`
				${args.scripts.syncVolumes}
			`)
			let cert
			try {
				let certpath = `${dirs.certbotcerts}${site.server_name}/privkey.pem`
				// cert = fs.readFileSync(dir)
				cert = shell.test('-e', certpath)
			} catch(err){
				// console.error('there,s no cert', cert)
			}
			console.log('cert,', cert)
			if(!cert){
				console.log('getting a letsencrypt certificate for '+site.server_name)
				let torun = args.scripts.certbotcertgenerator({
					domains: '-d '+site.server_name,
					prod: args.prod,
					email: 'lopudesigns@gmail.com',
				})
				console.log(torun)
				console.log('running certbotcertgenerator')
				shell.exec(`
					${torun}
				`)
				console.log('running syncVolumes')
				shell.exec(`
					${args.scripts.syncVolumes}
				`)
			} else {
				console.log(site.server_name+' already has a letsencrypt certificate')
			}
		
		}
	}
}

module.exports = generateCertbotCerts